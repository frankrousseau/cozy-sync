// Generated by CoffeeScript 1.10.0
var WebDAVAccount, cozydb, log, shortId;

cozydb = require('cozydb');

shortId = require('shortid');

log = require('printit')({
  prefix: 'webdavaccount:model'
});

module.exports = WebDAVAccount = cozydb.getModel('WebDAVAccount', {
  id: String,
  login: String,
  token: String,
  password: String,
  ctag: Number,
  cardctag: Number
});

WebDAVAccount.first = function(callback) {
  return WebDAVAccount.request('all', function(err, accounts) {
    var account;
    if (err) {
      return callback(err);
    } else if (!accounts || accounts.length === 0) {
      return callback(null, null);
    } else {
      account = accounts[0];
      if (account != null ? account.password : void 0) {
        log.info("WEBDAVACCOUNT HAS A PASSWORD, PATCHING");
        account.token = account.password;
        account.password = null;
        return account.save(function(err) {
          return callback(err, account);
        });
      } else {
        return callback(null, account);
      }
    }
  });
};

WebDAVAccount.set = function(data, callback) {
  return WebDAVAccount.first(function(err, account) {
    if (account == null) {
      return WebDAVAccount.create(data, callback);
    } else {
      return account.updateAttributes(data, callback);
    }
  });
};

WebDAVAccount.createAccount = function(callback) {
  var data;
  data = {
    login: 'me',
    token: shortId.generate()
  };
  return WebDAVAccount.set(data, callback);
};
